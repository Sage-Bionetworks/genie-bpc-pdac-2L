---
title: "Astellas 2L PDAC"
subtitle: "Feasibility report"
author: "Alex Paynter"
date: "`r format(Sys.Date(), '%d %b %Y')`"
editor_options:
  quarto:
    chunk_output_type: console
format:
  html:
    embed-resources: true
    toc: true
    toc-depth: 4
    theme: sandstone 
execute:
  echo: false
  include: false
  warning: false
  message: false
  fig.width: 7
  fig.height: 5
---

```{r}
library(fs)
library(purrr)
library(here)
purrr::walk(.x = fs::dir_ls(here("R")), .f = source)
```


## Introduction

This report addresses the feasibility of an Astellas study of second line therapies in pancreatic ductal adenocarcinoma.  We will leverage the existing curation in the pancreatic BPC (v1.2-consoritum) cohort to study the questions they've outlined.

## Attrition table

We'll show the table first, and detailed explanations follow below.  Each step in the table is cumulative, meaning that the second row states the number who meet the conditions in the first and second rows.

```{r}
flow_track <- readr::read_rds(
  here('data', 'flow_track.rds')
)

flow_track_ft <- flow_track %>%
  mutate(n = map_int(dat, nrow)) %>%
  select(message, n) %>%
  flextable() %>%
  set_header_labels(message = "Cohort description", n = "n") %>%
  theme_booktabs() %>%
  align(j = "n", align = "right") %>%
  fontsize(size = 10) %>%
  autofit()
```

```{r}
#| include: true
flow_track_ft
```

Details:

- **PDAC tumor** - At least one sample had the oncotree code for Pancreatic Adenocarcinoma (PAAD) or Adenosquamous Carcinoma of the Pancreas (PAASC), leaving out anyone with only Acinar Cell Carcinoma of the Pancreas (PAAC) and Undifferentiated Carcinoma of the Pancreas (UCP).
- **US sites only** Eliminated UHN from the cohort.
- **Only one cancer** The only cancer these people had is the pancreatic cancer that qualifies them for the cohort.  Only about 30 people had multiple cancers with pancreatic first, so it's almost certainly not worth it to open that can of worms.
- **Met dx. (anytime)** Limits to those who had a metastatic diagnosis at some point.  We'll check that their index therapy is in the metastatic state later.
- **KRAS G12D+** Had the mutation of interest in at least one NGS test.
- **1L gem/5FU-based** - The first line of therapy includes either gemcitabine or 5-FU (Fluorouracil).  Using the wording in inclusion criterion #3 from the protocol, **lines of therapy start with this exposure even if the exposure is before metastasis**.
- **Metastatic at 2L/3L** - the person is metastatic at the index therapy, which is either one or two therapies after the gem/5fu exposure.
- **No investigational agents** - the person had no investigational agents included in any therapies from the gem/5-FU to the index therapy.
- **Documented prog after 1L** - see section below.
  - Alternate to consider:  Everyone in the cohort did another therapy, you could argue that this could just be skipped if therapy is a sign of progression.




## Progression

Progression is defined as one of the following two events happening between 6 weeks (42 days) and 6 months (182 days) after the initiation of the gem/5-FU therapy:

- A medical oncology note documented a worsening, or an imaging report documented a worsening.
- There was a change in therapies, and there were no evaluations by imaging or medical oncology documented up to the date of the switch.

Further, progression flags in imaging and oncology infer that a switch from **no cancer** to **cancer** is a progression, or similarly that an imaging report showing cancer in a new region (e.g. brain) using the same type of image (e.g. CT) is a progression.  I will refer to this as longitudinal inference, and it's an added layer on top of what the BPC data show which will be important for ORR.

If we lose the longitudinal inference then the bottom number goes from about ~111 to ~97, with the advantage of having fewer decisions to defend for now.  This is virtually required for ORR since base BPC data affords almost no way to see a complete response without this step.  It's also an option to only do this with med onc notes, where this is more straightforward and defensible as we don't have regions or image types.

## Lines

```{r}
lot <- readr::read_rds(here('data', 'drug', 'lot.rds'))
cohort <- readr::read_rds(here('data', 'cohort.rds'))
```

The following table shows all the first line (gem/5-FU) therapies:

```{r}
#| include: true
library(DT)
lot %>%
  filter(record_id %in% cohort$record_id) %>%
  filter(line_of_therapy %in% 1) %>%
  count(regimen_drugs, sort = TRUE) %>%
  datatable(options = list(
    pageLength = 5,
    scrollX = TRUE
  ),
  caption = "Regimens for the Gem/5-FU exposure (1L)",
  rownames = FALSE)
```

This table shows the therapies used in the index line:

```{r}
#| include: true

cohort %>%
  select(record_id, line_of_therapy = index_line) %>%
  left_join(., select(lot, record_id, line_of_therapy, regimen_drugs),
            by = c('record_id', 'line_of_therapy')) %>% 
  count(regimen_drugs, sort = TRUE) %>%
  datatable(options = list(
    pageLength = 5,
    scrollX = TRUE
  ),
  caption = "Regimens for index therapy (2L/3L)",
  rownames = FALSE)
```

**Note:** Lots of these are Gem and 5-FU, too, which may or may not be what the sponsor was expecting.

## Issues

- **Kelli?** I took a stab at the tumor types that qualify as PDAC.  These are the four listed (I think the first two are PDAC - confirmif you know):
    - Pancreatic Adenocarcinoma (PAAD)
    - Adenosquamous Carcinoma of the Pancreas (PAASC)
    - Acinar Cell Carcinoma of the Pancreas (PAAC)
    - Undifferentiated Carcinoma of the Pancreas (UCP)
- We have not looked for duplicate or variant-of regimens which may follow the 1L.  For example, if someone does gem carbo after gem cis lots of people would not consider that a new line, but it may present that way in PRISSMM.
- I'll probably look at some of the people eliminated/kept in the last step to make sure nothing went wrong, there's a lot of code hidden in that compared to the rest of the steps.
